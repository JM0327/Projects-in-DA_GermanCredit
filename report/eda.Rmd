# 2. Exploratory data analysis    

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

## 2.1 Data structure and summary  
```{r}
Credit <- read.csv(here::here("data/GermanCredit.csv"), sep=";", header=T)
Credit.copy <- Credit #one for plot, one for calculation

Credit_factor <- Credit %>% select(-1,-3,-11,-14,-23,-27,-29) %>% colnames()
for(i in Credit_factor){
    Credit[,i] <- as.factor(Credit[,i])
} #shall we change all the variables which are not numerical into factor? 

Credit %>% datatable(rownames = FALSE,
                     option = list(scrollX = T,
                                   pageLength = 5))

```
<font color=red>
Q: Shall we change all the variables which are not numerical into factor? 
</font>
   
```{r}
str(Credit)
summary(Credit)
```
   
```{r}

print(dfSummary(Credit,style="grid",
                plain.ascii = FALSE, 
                tmp.img.dir = "/tmp",
                graph.magnif = 0.8),
      method = "render")
```

## 2.2 Graphs for variables  

### 2.2.1 Graph for response  
```{r}
p1 <- Credit %>% ggplot(mapping = aes(x=RESPONSE,fill=RESPONSE))+geom_bar()
p1
```

### 2.2.2 Graphs for numeric variables  
```{r}
#histogram/bar
Credit %>% select(-OBS.) %>% 
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_histogram()
```


### 2.2.3 Graphs for the purpose of credit variables  

```{r}
a <- unlist(Credit$NEW_CAR) 
NEW_CAR <- sum(a=="1")
b <- unlist(Credit$USED_CAR) 
USED_CAR <- sum(b=="1")
c <- unlist(Credit$FURNITURE) 
FURNITURE <- sum(c=="1")
d <- unlist(Credit$RADIO.TV) 
RADIO.TV <- sum(d=="1")
e <- unlist(Credit$EDUCATION)
EDUCATION <- sum(e=="1")
f <- unlist(Credit$RETRAINING)
RETRAINING <- sum(f=="1")
OTHERS <- 1000-(NEW_CAR+USED_CAR+FURNITURE+RADIO.TV+EDUCATION+RETRAINING)

reason <- c("NEW_CAR","USED_CAR","FURNITURE","RADIO.TV","EDUCATION","RETRAINING","OTHERS")
number <- c(NEW_CAR,USED_CAR,FURNITURE,RADIO.TV,EDUCATION,RETRAINING,OTHERS)
REASON_DATA <- data.frame(reason,number)

p2 <- ggplot(REASON_DATA,aes(x=reorder(reason,number),y=number,fill=reason))+geom_col()+
  geom_text(aes(label = number), vjust = 1.5, colour = "white", position = position_dodge(.9), size = 5)
p2
```

### 2.2.4 Graphs for other categorical variables  
```{r}
Credit %>% select(-5,-6,-7,-8,-9,-10) %>% 
  keep(is.factor) %>% 
  gather() %>% 
  ggplot(aes(x=value)) +
  facet_wrap(~ key, scales = "free") +
  geom_bar()
```
  
### 2.2.5 Observation profiling       
In this part, we would like to draw the profilling of observations ditinguished by different response. Thereby, it is possible to observe the performance / situation of observations subjects with good credit in each variable through the portrait.    
```{r}
Credit.copy[2:32] %>% 
  plot_boxplot(by='RESPONSE', ncol = 5)
```
<font color=red>
At the beginning, we want to use boxplot as above, but it is not suitable for binary variables
</font>

### 2.2.6 Correlation plot        
```{r, out.width= "150%", fig.width=100, fig.height=100}

corrplot(cor(Credit.copy[2:31]), 
          method = "color",
          addCoef.col="black",
          number.digits = 2,
          number.cex = 4,
          tl.cex=4, 
          tl.col="black")
```


# 3 Data preparation  

## 3.1 Balancing data  

```{r}
set.seed(416)
index.tr <- createDataPartition(y=Credit$RESPONSE,p=0.8,list=FALSE)
Credit.tr <- Credit[index.tr,]
Credit.te <- Credit[-index.tr,]
```


```{r}
table(Credit.tr$RESPONSE)
```

```{r}
No.good <- max(table(Credit.tr$RESPONSE))
Credit.tr.bad <- filter(Credit.tr, RESPONSE=="0")
Credit.tr.good <- filter(Credit.tr, RESPONSE=="1")

index.bad <- sample(size=No.good, x=1:nrow(Credit.tr.bad), replace=TRUE)
Credit.tr.res <- data.frame(rbind(Credit.tr.good, Credit.tr.bad[index.bad,]))
table(Credit.tr.res$RESPONSE)
```

## 3.2 Cross validation  
```{r}
trctrl <- trainControl(method = "cv",number = 10)
Credit.cv <- train(RESPONSE ~., data = Credit.tr.res, method = "rpart",
                    trControl=trctrl)
Credit.cv
```

```{r}
Credit.pred <- predict(Credit.cv,newdata=Credit.te)
confusionMatrix(data=Credit.pred, reference = Credit.te$RESPONSE)
```



