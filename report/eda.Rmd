# 2. Exploratory data analysis    

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

## 2.1 Data structure and summary  

### 2.1.1 Prepare the data
```{r}
Credit <- read.csv(here::here("data/GermanCredit.csv"), sep=";", header=T)
# Credit.copy <- Credit #one for plot, one for calculation

Credit_factor <- Credit %>% select(-3,-11,-14,-23,-27,-29) %>% colnames()
for(i in Credit_factor){
    Credit[,i] <- as.factor(Credit[,i])
} 

Credit %>% datatable(rownames = FALSE,
                     option = list(scrollX = T,
                                   pageLength = 5))

```

###2.1.2 Structure of data
```{r}
str(Credit)
summary(Credit)
```
   
```{r}

print(dfSummary(Credit,style="grid",
                plain.ascii = FALSE, 
                tmp.img.dir = "/tmp",
                graph.magnif = 0.8),
      method = "render")
```

###2.1.3 Mistakes found in the data
After checking the structure, we find some mistakes about the data and we correct these data.
1.Education:according to the data description, this variable is a binary type. 0 means the applicant has no education and 1 means the applicant has education. But we notice this variable has three categories. We need to change the category -1 to 1.
```{r}
table(Credit$EDUCATION)
Credit <- Credit %>% 
  mutate(EDUCATION=ifelse(EDUCATION %in% c("-1","1") , "1", "0"))
table(Credit$EDUCATION)
```
2.Guarantor:according to the data description, this variable is a binary type. 0 means the applicant has no guarantor and 1 means the applicant has guarantor. But we notice this variable has three categories. We need to change the category 2 to 1.
```{r}
table(Credit$GUARANTOR)
Credit <- Credit %>% 
  mutate(GUARANTOR=ifelse(GUARANTOR %in% c("2","1") , "1", "0"))
table(Credit$GUARANTOR)
```
3.PRESENT_RESIDENT:according to the data description, this variable has these 4 categories:0, 1, 2, 3. We need to change category 1 to category 0, change category 2 to category 1, change category 3 to category 2 and change category 4 to category 3.
```{r}
table(Credit$PRESENT_RESIDENT)
levels(Credit$PRESENT_RESIDENT)[1] <- 0
levels(Credit$PRESENT_RESIDENT)[2] <- 1
levels(Credit$PRESENT_RESIDENT)[3] <- 2
levels(Credit$PRESENT_RESIDENT)[4] <- 3
table(Credit$PRESENT_RESIDENT)
```

4.AGE:the maximum age is 125 which is impossible so we change it to 75. 
```{r}
summary(Credit$AGE)
Credit$AGE[Credit$AGE == 125] <- 75
summary(Credit$AGE)
```


## 2.2 Graphs for variables  

### 2.2.1 Graph for response 
We find the data set is unbalanced.

```{r}
p1 <- Credit %>% ggplot(mapping = aes(x=RESPONSE,fill=RESPONSE))+geom_bar()
p1
```

### 2.2.2 Graphs for numeric variables  
```{r}
#Continuous Variables
Credit %>% select(-INSTALL_RATE,-NUM_CREDITS,-NUM_DEPENDENTS) %>% 
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_histogram()
```


```{r}
#Discrete variables
Credit %>% select(-AGE,-AMOUNT,-DURATION) %>% 
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_bar()
```


```{r}
#mosaic(for numeric variable)
```


### 2.2.3 Graphs for the purpose of credit variables  

```{r}
a <- unlist(Credit$NEW_CAR) 
NEW_CAR <- sum(a=="1")
b <- unlist(Credit$USED_CAR) 
USED_CAR <- sum(b=="1")
c <- unlist(Credit$FURNITURE) 
FURNITURE <- sum(c=="1")
d <- unlist(Credit$RADIO.TV) 
RADIO.TV <- sum(d=="1")
e <- unlist(Credit$EDUCATION)
EDUCATION <- sum(e=="1")
f <- unlist(Credit$RETRAINING)
RETRAINING <- sum(f=="1")
OTHERS <- 1000-(NEW_CAR+USED_CAR+FURNITURE+RADIO.TV+EDUCATION+RETRAINING)

reason <- c("NEW_CAR","USED_CAR","FURNITURE","RADIO.TV","EDUCATION","RETRAINING","OTHERS")
number <- c(NEW_CAR,USED_CAR,FURNITURE,RADIO.TV,EDUCATION,RETRAINING,OTHERS)
REASON_DATA <- data.frame(reason,number)

p2 <- ggplot(REASON_DATA,aes(x=reorder(reason,number),y=number,fill=reason))+geom_col()+
  geom_text(aes(label = number), vjust = 1.5, colour = "white", position = position_dodge(.9), size = 5)
p2
```

### 2.2.4 Graphs for other categorical variables  
```{r}
Credit %>% select(-5,-6,-7,-8,-9,-10) %>% 
  keep(is.factor) %>% 
  gather() %>% 
  ggplot(aes(x=value)) +
  facet_wrap(~ key, scales = "free") +
  geom_bar()
```
  
```{r}
Credit %>% select(12,13,28,32) %>% ggpairs()
```

### 2.2.5 Observation profiling       
In this part, we would like to draw the profilling of observations ditinguished by different response. Thereby, it is possible to observe the performance / situation of observations subjects with good credit in each variable through the portrait.    
```{r}
Credit.copy[2:32] %>% 
  plot_boxplot(by='RESPONSE', ncol = 5)
```
<font color=red>
At the beginning, we want to use boxplot as above, but it is not suitable for binary variables
</font>

### 2.2.6 Correlation plot        
```{r, out.width= "150%", fig.width=100, fig.height=100}

corrplot(cor(Credit.copy[2:32]), 
          method = "color",
          addCoef.col="black",
          number.digits = 2,
          number.cex = 4,
          tl.cex=4, 
          tl.col="black")
```
